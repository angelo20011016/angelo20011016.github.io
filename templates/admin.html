<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>後台管理</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <!-- TinyMCE 富文本編輯器 -->
  <script src="https://cdn.tiny.cloud/1/qkdgsbcewaylzbk240sfwfmc231zlz8b9rchmwrqu0z77etc/tinymce/5/tinymce.min.js" referrerpolicy="origin"></script>
  <style>
    :root {
        --primary-color: #3a6ea5;
        --secondary-color: #f0f5fa;
        --dark-color: #2a3f54;
        --light-color: #ffffff;
        --text-color: #4a4a4a;
        --border-radius: 10px;
    }
    
    body {
        color: var(--text-color);
        font-family: 'Noto Sans TC', sans-serif;
        background-color: #f8f9fa;
    }
    
    .sidebar {
        min-height: 100vh;
        background-color: var(--dark-color);
        border-right: 1px solid rgba(0,0,0,0.08);
        box-shadow: 0 0 15px rgba(0,0,0,0.05);
    }
    
    .content {
        padding: 25px;
    }
    
    .nav-link {
        color: rgba(255,255,255,0.7);
        border-radius: var(--border-radius);
        margin: 5px 10px;
        padding: 10px;
        transition: all 0.2s ease;
    }
    
    .nav-link:hover, .nav-link.active {
        color: #fff;
        background-color: rgba(255,255,255,0.1);
    }
    
    /* 卡片樣式 */
    .card {
        border: none;
        border-radius: var(--border-radius);
        margin-bottom: 1.5rem;
        box-shadow: 0 3px 10px rgba(0,0,0,0.04);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .card:hover {
        transform: translateY(-3px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.08);
    }
    
    .card-header {
        background-color: var(--light-color);
        border-bottom: 1px solid rgba(0,0,0,0.05);
        font-weight: 600;
        padding: 15px 20px;
        border-radius: var(--border-radius) var(--border-radius) 0 0 !important;
    }
    
    .card-dashboard {
        position: relative;
        overflow: hidden;
        z-index: 1;
    }
    
    .card-dashboard::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        height: 100%;
        width: 5px;
        background-color: var(--primary-color);
        z-index: 2;
    }
    
    /* 表單樣式 */
    .form-control {
        border-radius: var(--border-radius);
        padding: 10px 15px;
    }
    
    .form-control:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 0.25rem rgba(58, 110, 165, 0.15);
    }
    
    .btn {
        border-radius: var(--border-radius);
        padding: 8px 15px;
        transition: all 0.2s ease;
    }
    
    /* 按鈕樣式 */
    .btn-primary {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
    }
    
    .btn-primary:hover {
        background-color: #2e5a8b;
        border-color: #2e5a8b;
    }
    
    /* 訊息卡片 */
    .message-card {
        transition: all 0.2s ease;
    }
    
    .message-card.unread {
        border-left: 4px solid #dc3545;
    }
    
    /* 數據徽章 */
    .stat-badge {
        padding: 20px;
        border-radius: var(--border-radius);
        background-color: var(--secondary-color);
    }
    
    /* 標籤頁激活樣式 */
    .nav-tabs .nav-link.active {
        color: var(--primary-color);
        font-weight: 600;
    }
    
    /* 富文本編輯器樣式 */
    .tox-tinymce {
        border-radius: var(--border-radius) !important;
    }
  </style>
</head>
<body>
  <div class="container-fluid">
    <div class="row">
      <!-- 側邊欄 -->
      <div class="col-md-2 px-0 sidebar">
        <div class="p-3">
          <h5 class="text-white">管理後台</h5>
        </div>
        <ul class="nav flex-column mt-4">
          <li class="nav-item">
            <a class="nav-link active" data-bs-toggle="tab" href="#dashboard">
              <i class="fas fa-tachometer-alt me-2"></i>儀表板
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" data-bs-toggle="tab" href="#portfolio">
              <i class="fas fa-folder-open me-2"></i>作品集管理
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" data-bs-toggle="tab" href="#subscribers">
              <i class="fas fa-envelope me-2"></i>電子報訂閱
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" data-bs-toggle="tab" href="#contacts">
              <i class="fas fa-comment me-2"></i>聯絡訊息
            </a>
          </li>
          <li class="nav-item mt-5">
            <a class="nav-link" href="/logout">
              <i class="fas fa-sign-out-alt me-2"></i>登出
            </a>
          </li>
        </ul>
      </div>
      
      <!-- 主要內容區 -->
      <div class="col-md-10 content">
        <div class="tab-content">
          <!-- 儀表板 -->
          <div class="tab-pane fade show active" id="dashboard">
            <h2 class="mb-4">儀表板</h2>
            <div class="row">
              <div class="col-md-4">
                <div class="card card-dashboard mb-4">
                  <div class="card-body">
                    <div class="d-flex justify-content-between">
                      <div>
                        <h5 class="card-title">作品數量</h5>
                        <h2 id="portfolioCount">--</h2>
                      </div>
                      <div class="fs-1 text-secondary">
                        <i class="fas fa-folder"></i>
                      </div>
                    </div>
                    <a href="#portfolio" data-bs-toggle="tab" class="card-link">查看詳情</a>
                  </div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="card card-dashboard mb-4">
                  <div class="card-body">
                    <div class="d-flex justify-content-between">
                      <div>
                        <h5 class="card-title">訂閱者數量</h5>
                        <h2 id="subscriberCount">--</h2>
                      </div>
                      <div class="fs-1 text-secondary">
                        <i class="fas fa-envelope"></i>
                      </div>
                    </div>
                    <a href="#subscribers" data-bs-toggle="tab" class="card-link">查看詳情</a>
                  </div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="card card-dashboard mb-4">
                  <div class="card-body">
                    <div class="d-flex justify-content-between">
                      <div>
                        <h5 class="card-title">未讀訊息</h5>
                        <h2 id="unreadCount">--</h2>
                      </div>
                      <div class="fs-1 text-secondary">
                        <i class="fas fa-comment"></i>
                      </div>
                    </div>
                    <a href="#contacts" data-bs-toggle="tab" class="card-link">查看詳情</a>
                  </div>
                </div>
              </div>
            </div>
            <div class="card">
              <div class="card-header">最近活動</div>
              <div class="card-body">
                <div id="recentActivities">
                  <p class="text-center text-muted">載入中...</p>
                </div>
              </div>
            </div>
          </div>
          
          <!-- 作品集管理 -->
          <div class="tab-pane fade" id="portfolio">
            <h2 class="mb-4">作品集管理</h2>
            <div class="card mb-4">
              <div class="card-header">新增作品</div>
              <div class="card-body">
                <form id="portfolioForm">
                  <div class="mb-3">
                    <label for="title" class="form-label">標題</label>
                    <input type="text" class="form-control" id="title" name="title" required>
                  </div>
                  <div class="mb-3">
                    <label for="description" class="form-label">描述</label>
                    <textarea class="form-control" id="description" name="description" rows="8" required></textarea>
                    <small class="text-muted">支持HTML格式和富文本編輯</small>
                  </div>
                  <div class="mb-3">
                    <label for="image_url" class="form-label">圖片網址</label>
                    <input type="url" class="form-control" id="image_url" name="image_url">
                  </div>
                  <div class="mb-3">
                    <label for="project_url" class="form-label">專案連結</label>
                    <input type="url" class="form-control" id="project_url" name="project_url">
                  </div>
                  <div class="mb-3">
                    <label for="tags" class="form-label">標籤 (以逗號分隔)</label>
                    <input type="text" class="form-control" id="tags" name="tags">
                  </div>
                  <button type="button" class="btn btn-primary" onclick="submitPortfolio()">新增</button>                </form>
              </div>
            </div>
            
            <div class="card">
              <div class="card-header">作品列表</div>
              <div class="card-body">
                <div id="portfolioList" class="row">
                  <p class="text-center">載入中...</p>
                </div>
              </div>
            </div>
          </div>
          
          <!-- 電子報訂閱管理 -->
          <div class="tab-pane fade" id="subscribers">
            <h2 class="mb-4">電子報訂閱管理</h2>
            <div class="card">
              <div class="card-header">訂閱者列表</div>
              <div class="card-body">
                <div class="table-responsive">
                  <table class="table table-striped">
                    <thead>
                      <tr>
                        <th>電子郵件</th>
                        <th>訂閱日期</th>
                        <th>訂閱來源</th>
                        <th>狀態</th>
                        <th>操作</th>
                      </tr>
                    </thead>
                    <tbody id="subscribersTableBody">
                      <tr>
                        <td colspan="5" class="text-center">載入中...</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
          
          <!-- 聯絡訊息管理 -->
          <div class="tab-pane fade" id="contacts">
            <h2 class="mb-4">聯絡訊息管理</h2>
            <div class="card">
              <div class="card-header">訊息列表</div>
              <div class="card-body">
                <div id="contactsList">
                  <p class="text-center">載入中...</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 作品編輯模態框 -->
  <div class="modal fade" id="editPortfolioModal" tabindex="-1" aria-labelledby="editPortfolioModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editPortfolioModalLabel">編輯作品</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="editPortfolioForm">
            <input type="hidden" id="edit-portfolio-id">
            <div class="mb-3">
              <label for="edit-title" class="form-label">標題</label>
              <input type="text" class="form-control" id="edit-title" name="title" required>
            </div>
            <div class="mb-3">
              <label for="edit-description" class="form-label">描述</label>
              <textarea class="form-control" id="edit-description" name="description" rows="8" required></textarea>
            </div>
            <div class="mb-3">
              <label for="edit-image_url" class="form-label">圖片網址</label>
              <input type="url" class="form-control" id="edit-image_url" name="image_url">
            </div>
            <div class="mb-3">
              <label for="edit-github_url" class="form-label">GitHub 連結</label>
              <input type="url" class="form-control" id="edit-github_url" name="github_url">
            </div>
            <div class="mb-3">
              <label for="edit-demo_url" class="form-label">Demo 連結</label>
              <input type="url" class="form-control" id="edit-demo_url" name="demo_url">
            </div>
            <div class="mb-3">
              <label for="edit-tags" class="form-label">標籤 (以逗號分隔)</label>
              <input type="text" class="form-control" id="edit-tags" name="tags">
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button type="button" class="btn btn-primary" id="saveEditBtn">保存更改</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    // 頁面載入完成後執行
    document.addEventListener('DOMContentLoaded', function() {
      console.log("頁面已完全載入");
      
      // 初始化富文本編輯器
      tinymce.init({
        selector: '#description',
        height: 300,
        plugins: 'advlist autolink lists link image charmap print preview anchor ' +
                'searchreplace visualblocks code fullscreen ' +
                'insertdatetime media table paste code help wordcount',
        toolbar: 'undo redo | formatselect | ' +
                'bold italic backcolor | alignleft aligncenter ' +
                'alignright alignjustify | bullist numlist outdent indent | ' +
                'removeformat | help',
        language: 'zh_TW',
        menubar: 'file edit view insert format tools table help',
        content_style: 'body { font-family: "Noto Sans TC", sans-serif; font-size: 16px; }'
      });
      
      // 為編輯模態框也初始化富文本編輯器
      tinymce.init({
        selector: '#edit-description',
        height: 300,
        plugins: 'advlist autolink lists link image charmap print preview anchor ' +
                'searchreplace visualblocks code fullscreen ' +
                'insertdatetime media table paste code help wordcount',
        toolbar: 'undo redo | formatselect | ' +
                'bold italic backcolor | alignleft aligncenter ' +
                'alignright alignjustify | bullist numlist outdent indent | ' +
                'removeformat | help',
        language: 'zh_TW',
        menubar: 'file edit view insert format tools table help',
        content_style: 'body { font-family: "Noto Sans TC", sans-serif; font-size: 16px; }'
      });
      
      // 載入作品集資料
      loadPortfolioItems();
      
      // 綁定標籤頁點擊事件
      document.querySelector('a[href="#subscribers"]').addEventListener('click', fetchSubscribers);
      document.querySelector('a[href="#contacts"]').addEventListener('click', fetchContacts);
      
      // 處理作品新增表單提交
      const portfolioForm = document.getElementById('portfolioForm');
      if (portfolioForm) {
        console.log("已找到作品表單，綁定提交事件");
        
        portfolioForm.addEventListener('submit', function(e) {
          e.preventDefault();
          console.log("表單提交觸發");
          
          // 獲取富文本編輯器內容
          const description = tinymce.get('description').getContent();
          console.log("富文本內容:", description.substring(0, 50) + "...");
          
          // 獲取 project_url 值
          const projectUrl = document.getElementById('project_url') ? 
                          document.getElementById('project_url').value : '';
          
          const formData = {
            title: document.getElementById('title').value,
            description: description,
            image_url: document.getElementById('image_url').value,
            github_url: projectUrl,  // 將 project_url 映射到 github_url
            tags: document.getElementById('tags').value.split(',').map(tag => tag.trim()).filter(tag => tag)
          };
          
          console.log("提交的表單數據:", formData);
          
          // 使用 fetch 發送資料
          fetch('/api/portfolio', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
          })
          .then(response => {
            console.log("API響應狀態:", response.status);
            return response.json();
          })
          .then(data => {
            console.log("API響應數據:", data);
            if (data.success) {
              alert('作品新增成功');
              portfolioForm.reset();
              tinymce.get('description').setContent(''); // 清空富文本編輯器
              loadPortfolioItems(); // 重新載入作品列表
            } else {
              alert('作品新增失敗: ' + (data.message || '未知錯誤'));
            }
          })
          .catch(error => {
            console.error('Error:', error);
            alert('發生錯誤，請稍後再試');
          });
        });
      } else {
        console.error("找不到作品表單元素!");
      }
      
      // 綁定保存編輯按鈕的點擊事件
      const saveEditBtn = document.getElementById('saveEditBtn');
      if (saveEditBtn) {
        saveEditBtn.addEventListener('click', saveEditedPortfolio);
        console.log("已綁定保存編輯按鈕");
      } else {
        console.error("找不到保存編輯按鈕!");
      }
      
      // 載入儀表板資料
      loadDashboard();
    });
    // 直接處理表單提交
    function submitPortfolio() {
    console.log("表單提交函數觸發");
    
    const title = document.getElementById('title').value;
    
    // 嘗試獲取富文本編輯器內容
    let description = "";
    try {
        const editor = tinymce.get('description');
        if (editor) {
        description = editor.getContent();
        } else {
        description = document.getElementById('description').value;
        alert("警告：編輯器未初始化，將使用純文本");
        }
    } catch (err) {
        console.error("獲取富文本內容錯誤:", err);
        description = document.getElementById('description').value;
    }
    
    const formData = {
        title: title,
        description: description,
        image_url: document.getElementById('image_url').value,
        github_url: document.getElementById('project_url').value,
        tags: document.getElementById('tags').value.split(',').map(tag => tag.trim()).filter(tag => tag)
    };
    
    console.log("提交的表單數據:", formData);
    
    // 使用 fetch 發送資料
    fetch('/api/portfolio', {
        method: 'POST',
        headers: {
        'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => {
        console.log("API響應狀態:", response.status);
        return response.json();
    })
    .then(data => {
        console.log("API響應數據:", data);
        if (data.success) {
        alert('作品新增成功');
        // 清空表單
        document.getElementById('title').value = '';
        document.getElementById('image_url').value = '';
        document.getElementById('project_url').value = '';
        document.getElementById('tags').value = '';
        
        // 清空富文本編輯器
        try {
            const editor = tinymce.get('description');
            if (editor) {
            editor.setContent('');
            }
        } catch (err) {
            console.error("清空富文本編輯器錯誤:", err);
        }
        
        // 重新載入作品列表
        loadPortfolioItems();
        } else {
        alert('作品新增失敗: ' + (data.message || '未知錯誤'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('發生錯誤，請稍後再試');
    });
    }
    // 載入儀表板
    function loadDashboard() {
      // 載入作品數量
      fetch('/api/portfolio/count')
        .then(response => response.json())
        .then(data => {
          document.getElementById('portfolioCount').textContent = data.count || 0;
        })
        .catch(error => {
          console.error('Error:', error);
          document.getElementById('portfolioCount').textContent = '0';
        });
      
      // 載入訂閱者數量
      fetch('/api/newsletter/subscribers/count')
        .then(response => response.json())
        .then(data => {
          document.getElementById('subscriberCount').textContent = data.count || 0;
        })
        .catch(error => {
          console.error('Error:', error);
          document.getElementById('subscriberCount').textContent = '0';
        });
      
      // 載入未讀訊息數量
      fetch('/api/contacts/unread/count')
        .then(response => response.json())
        .then(data => {
          document.getElementById('unreadCount').textContent = data.count || 0;
        })
        .catch(error => {
          console.error('Error:', error);
          document.getElementById('unreadCount').textContent = '0';
        });
      
      // 載入最近活動
      fetch('/api/recent-activities')
        .then(response => response.json())
        .then(data => {
          if (data && data.length > 0) {
            const activitiesHTML = data.map(activity => `
              <div class="d-flex align-items-center mb-3">
                <div class="flex-shrink-0">
                  <i class="fas ${activity.icon || 'fa-circle'} me-2"></i>
                </div>
                <div class="flex-grow-1 ms-2">
                  ${activity.message}
                  <small class="text-muted ms-2">${activity.time}</small>
                </div>
              </div>
            `).join('');
            document.getElementById('recentActivities').innerHTML = activitiesHTML;
          } else {
            document.getElementById('recentActivities').innerHTML = '<p class="text-center text-muted">暫無活動</p>';
          }
        })
        .catch(error => {
          console.error('Error:', error);
          document.getElementById('recentActivities').innerHTML = '<p class="text-center text-muted">載入失敗</p>';
        });
    }
    
    // 獲取訂閱者列表
    function fetchSubscribers() {
      fetch('/api/newsletter/subscribers')
        .then(response => response.json())
        .then(data => {
          const tableBody = document.getElementById('subscribersTableBody');
          tableBody.innerHTML = '';
          
          if (!data || data.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="5" class="text-center">暫無訂閱者</td></tr>';
            return;
          }
          
          data.forEach(subscriber => {
            const statusBadge = subscriber.active 
              ? '<span class="badge bg-success">活躍</span>' 
              : '<span class="badge bg-secondary">已取消</span>';
              
            tableBody.innerHTML += `
              <tr>
                <td>${subscriber.email}</td>
                <td>${subscriber.subscribed_at || '未知'}</td>
                <td>${subscriber.source || '網站'}</td>
                <td>${statusBadge}</td>
                <td>
                  ${subscriber.active 
                    ? `<button class="btn btn-sm btn-outline-danger" onclick="unsubscribe('${subscriber._id}')">設為取消</button>` 
                    : `<button class="btn btn-sm btn-outline-success" onclick="resubscribe('${subscriber._id}')">重新啟用</button>`}
                </td>
              </tr>
            `;
          });
        })
        .catch(error => {
          console.error('Error:', error);
          document.getElementById('subscribersTableBody').innerHTML = 
            '<tr><td colspan="5" class="text-center text-danger">載入失敗，請重試</td></tr>';
        });
    }
    
    // 獲取聯絡訊息
    function fetchContacts() {
      fetch('/api/contacts')
        .then(response => response.json())
        .then(data => {
          const contactsList = document.getElementById('contactsList');
          contactsList.innerHTML = '';
          
          if (!data || data.length === 0) {
            contactsList.innerHTML = '<p class="text-center">暫無聯絡訊息</p>';
            return;
          }
          
          data.forEach(contact => {
            const readBadge = contact.read 
              ? '<span class="badge bg-secondary">已讀</span>' 
              : '<span class="badge bg-danger">未讀</span>';
              
            const repliedBadge = contact.replied 
              ? '<span class="badge bg-success">已回覆</span>' 
              : '<span class="badge bg-warning">未回覆</span>';
            
            contactsList.innerHTML += `
              <div class="card mb-3 ${!contact.read ? 'border-danger' : ''}">
                <div class="card-header d-flex justify-content-between align-items-center">
                  <div>
                    <strong>${contact.name}</strong> (${contact.email})
                    <small class="text-muted ms-2">${contact.created_at}</small>
                  </div>
                  <div>
                    ${readBadge} ${repliedBadge}
                    <div class="btn-group ms-2">
                      ${!contact.read ? 
                        `<button class="btn btn-sm btn-outline-primary" onclick="markAsRead('${contact._id}')">標記已讀</button>` : ''}
                      ${!contact.replied ? 
                        `<button class="btn btn-sm btn-outline-success" onclick="markAsReplied('${contact._id}')">標記已回覆</button>` : ''}
                    </div>
                  </div>
                </div>
                <div class="card-body">
                  <p class="card-text">${contact.message}</p>
                </div>
              </div>
            `;
          });
        })
        .catch(error => {
          console.error('Error:', error);
          document.getElementById('contactsList').innerHTML = 
            '<p class="text-center text-danger">載入失敗，請重試</p>';
        });
    }
    
    // 標記訊息為已讀
    function markAsRead(contactId) {
      fetch(`/api/contacts/${contactId}/read`, {
        method: 'PUT'
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          fetchContacts();
        } else {
          alert('操作失敗，請重試');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('操作失敗，請重試');
      });
    }
    
    // 標記訊息為已回覆
    function markAsReplied(contactId) {
      fetch(`/api/contacts/${contactId}/replied`, {
        method: 'PUT'
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          fetchContacts();
        } else {
          alert('操作失敗，請重試');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('操作失敗，請重試');
      });
    }
    
    // 取消訂閱處理
    function unsubscribe(subscriberId) {
      if(confirm('確定要將此用戶設為已取消訂閱嗎？')) {
        fetch(`/api/newsletter/subscribers/${subscriberId}/unsubscribe`, {
          method: 'PUT'
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            fetchSubscribers();
          } else {
            alert('操作失敗，請重試');
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('操作失敗，請重試');
        });
      }
    }
    
    // 重新訂閱處理
    function resubscribe(subscriberId) {
      fetch(`/api/newsletter/subscribers/${subscriberId}/resubscribe`, {
        method: 'PUT'
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          fetchSubscribers();
        } else {
          alert('操作失敗，請重試');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('操作失敗，請重試');
      });
    }
    
    // 載入作品集項目
    function loadPortfolioItems() {
      console.log("正在載入作品列表...");
      
      fetch('/api/portfolio')
        .then(response => {
          console.log("作品列表API響應狀態:", response.status);
          return response.json();
        })
        .then(data => {
          console.log(`載入了 ${data.length} 個作品項目`);
          
          const portfolioList = document.getElementById('portfolioList');
          if (!portfolioList) {
            console.error("找不到portfolioList元素!");
            return;
          }
          
          portfolioList.innerHTML = '';
          
          if (!data || data.length === 0) {
            portfolioList.innerHTML = '<div class="col-12 text-center">暫無作品</div>';
            return;
          }
          
          data.forEach(item => {
            // 創建一個安全的描述摘要
            let safeDesc = '';
            if (item.description) {
              // 移除HTML標籤，取前100個字符
              safeDesc = item.description.replace(/<[^>]*>/g, '')
                .substring(0, 100) + (item.description.length > 100 ? '...' : '');
            }
            
            portfolioList.innerHTML += `
              <div class="col-md-4 mb-4">
                <div class="card h-100">
                  <img src="${item.image_url || 'https://via.placeholder.com/300x200?text=無圖片'}" class="card-img-top" 
                      alt="${item.title}" style="height: 200px; object-fit: cover;">
                  <div class="card-body">
                    <h5 class="card-title">${item.title}</h5>
                    <p class="card-text">${safeDesc}</p>
                    ${item.tags && item.tags.length > 0 ? 
                      `<div class="mb-2">
                        ${item.tags.map(tag => `<span class="badge bg-secondary me-1">${tag}</span>`).join('')}
                      </div>` : ''}
                  </div>
                  <div class="card-footer bg-white d-flex justify-content-between">
                    <button class="btn btn-sm btn-outline-primary" onclick="editPortfolio('${item._id}')">編輯</button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deletePortfolio('${item._id}')">刪除</button>
                  </div>
                </div>
              </div>
            `;
          });
        })
        .catch(error => {
          console.error('獲取作品列表失敗:', error);
          
          const portfolioList = document.getElementById('portfolioList');
          if (portfolioList) {
            portfolioList.innerHTML = '<div class="col-12 text-center text-danger">載入作品列表失敗</div>';
          }
        });
    }
    
    // 刪除作品
    function deletePortfolio(id) {
      if (confirm('確定要刪除此作品？')) {
        fetch(`/api/portfolio/${id}`, {
          method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert('刪除成功');
            loadPortfolioItems();
            loadDashboard(); // 更新儀表板數據
          } else {
            alert('刪除失敗: ' + data.message);
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('發生錯誤，請稍後再試');
        });
      }
    }
    
    // 編輯作品
    function editPortfolio(id) {
      console.log("編輯作品:", id);
      
      fetch(`/api/portfolio/${id}`)
        .then(response => {
          console.log("編輯作品API響應狀態:", response.status);
          return response.json();
        })
        .then(portfolio => {
          console.log("載入作品詳情:", portfolio);
          
          // 填充表單
          document.getElementById('edit-portfolio-id').value = portfolio._id;
          document.getElementById('edit-title').value = portfolio.title;
          tinymce.get('edit-description').setContent(portfolio.description || '');
          document.getElementById('edit-image_url').value = portfolio.image_url || '';
          document.getElementById('edit-github_url').value = portfolio.github_url || '';
          document.getElementById('edit-demo_url').value = portfolio.demo_url || '';
          
          // 標籤處理
          if (portfolio.tags && Array.isArray(portfolio.tags)) {
            document.getElementById('edit-tags').value = portfolio.tags.join(', ');
          } else {
            document.getElementById('edit-tags').value = '';
          }
          
          // 顯示模態框
          const editModal = new bootstrap.Modal(document.getElementById('editPortfolioModal'));
          editModal.show();
        })
        .catch(error => {
          console.error('獲取作品詳情失敗:', error);
          alert('無法獲取作品詳情，請稍後再試');
        });
    }
    
    // 保存編輯後的作品
    function saveEditedPortfolio() {
      const portfolioId = document.getElementById('edit-portfolio-id').value;
      console.log("儲存編輯的作品:", portfolioId);
      
      const formData = {
        title: document.getElementById('edit-title').value,
        description: tinymce.get('edit-description').getContent(),
        image_url: document.getElementById('edit-image_url').value,
        github_url: document.getElementById('edit-github_url').value,
        demo_url: document.getElementById('edit-demo_url').value,
        tags: document.getElementById('edit-tags').value.split(',').map(tag => tag.trim()).filter(tag => tag)
      };
      
      console.log("提交的編輯資料:", formData);
      
      fetch(`/api/portfolio/${portfolioId}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
      })
      .then(response => {
        console.log("編輯API響應狀態:", response.status);
        return response.json();
      })
      .then(data => {
        console.log("編輯API響應資料:", data);
        
        if (data.success) {
          // 關閉模態框
          const editModal = bootstrap.Modal.getInstance(document.getElementById('editPortfolioModal'));
          editModal.hide();
          
          // 顯示成功消息
          alert('作品更新成功');
          
          // 重新載入作品列表
          loadPortfolioItems();
        } else {
          alert('更新失敗: ' + (data.message || '未知錯誤'));
        }
      })
      .catch(error => {
        console.error('更新作品失敗:', error);
        alert('發生錯誤，請稍後再試');
      });
    }
  </script>
</body>
</html>