<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>即時翻譯 | Angelo</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <link rel="icon" href="https://img5.uploadhouse.com/fileuploads/31937/319376154887c9e20b063d9725d84b4b64b8a18d.png" type="image/png">
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <style>
    body { background-color: #FAFAFA; color: #3E2723; font-family: 'Roboto', sans-serif; }
    .navbar { background: rgba(250, 250, 250, 0.9); box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05); }
    .card { background: #FFFFFF; box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.1); border-radius: 12px; }
    .btn { border: 2px solid #3E2723; color: #3E2723; transition: all 0.3s ease; }
    .btn:hover { background: #3E2723; color: white; }
    .btn-primary { background: #3E2723; color: white; }
    .btn-primary:hover { background: #5D4037; }
    .status-indicator { height: 12px; width: 12px; border-radius: 50%; display: inline-block; vertical-align: middle; transition: background-color 0.3s ease; }
    .status-idle { background-color: #BDBDBD; }
    .status-recording { background-color: #E53935; animation: pulse 1.5s infinite; }
    .status-processing { background-color: #FFB300; }
    @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(229, 57, 53, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(229, 57, 53, 0); } 100% { box-shadow: 0 0 0 0 rgba(229, 57, 53, 0); } }
    .transcript-container { height: 300px; overflow-y: auto; padding: 1rem; background-color: #f9f9f9; border-radius: 8px; }
    .transcript-pair { margin-bottom: 1rem; }
    .transcript-text { padding: 0.75rem; border-radius: 8px; }
    .original-text { background-color: #e3f2fd; color: #1e88e5; }
    .translated-text { background-color: #f3e5f5; color: #8e24aa; }
  </style>
</head>
<body class="pt-20">

  <section class="navbar w-full fixed top-0 left-0 z-50 py-4 px-6">
    <div class="container mx-auto flex items-center justify-between">
      <a href="/about.html" class="text-2xl font-bold">HappyWeCan</a>
      <nav class="hidden lg:flex space-x-6">
        <a href="/about.html" class="hover:text-gray-500">關於我</a>
        <a href="/portfolio.html" class="hover:text-gray-500">作品集</a>
        <a href="/blog.html" class="hover:text-gray-500">部落格</a>
        <a href="/contactme.html" class="hover:text-gray-500">聯絡我</a>
        <a href="/translator" class="font-bold text-amber-800">即時翻譯</a>
      </nav>
      <button id="mobile-menu-button" class="lg:hidden text-3xl">☰</button>
    </div>
    <div id="mobile-menu" class="hidden w-full bg-white shadow-lg absolute left-0 top-full mt-1 py-4 lg:hidden">
        </div>
  </section>

  <section class="container mx-auto py-16 px-6 max-w-4xl">
    <div class="card p-8">
      <div class="text-center mb-8">
        <h1 class="text-4xl font-bold">即時語音翻譯</h1>
        <div class="mt-4 flex justify-center items-center gap-4">
            <select id="source-lang" class="py-2 px-3 border border-gray-300 rounded-lg focus:ring-amber-800 focus:border-amber-800">
                <option value="zh-TW">中文 (繁體)</option>
                <option value="en-US">English (US)</option>
                <option value="ja-JP">日本語</option>
            </select>
            <button id="swap-lang-btn" class="btn p-2 rounded-full w-10 h-10 flex items-center justify-center">
                <i class="fas fa-exchange-alt"></i>
            </button>
            <select id="target-lang" class="custom-select bg-white py-2 px-4 border border-gray-300 rounded-lg focus:ring-amber-800 focus:border-amber-800">
                <option value="ja-JP">日本語</option>
                <option value="en-US">English (US)</option>
                <option value="zh-TW">中文 (繁體)</option>
            </select>
        </div>
      </div>

      <div class="flex flex-col items-center justify-center space-y-4 mb-8">
        <button id="start-btn" class="btn-primary rounded-full w-40 h-12 flex items-center justify-center text-lg shadow-lg transform hover:scale-105 transition-transform">
          <i class="fas fa-play mr-2"></i>開始翻譯
        </button>
        <div class="flex items-center space-x-3">
          <div id="status-indicator" class="status-indicator status-idle"></div>
          <span id="status-text" class="text-lg text-gray-600">待機中</span>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <h2 id="source-lang-header" class="text-xl font-bold mb-2">原文</h2>
          <div id="original-transcript" class="transcript-container"></div>
        </div>
        <div>
            <div class="flex items-center justify-between mb-2">
                <h2 id="target-lang-header" class="text-xl font-bold">翻譯</h2>
            </div>
          <div id="translated-transcript" class="transcript-container"></div>
        </div>
      </div>
    </div>
  </section>

  <footer class="bg-gray-100 text-gray-800 py-6 mt-12">
      </footer>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
        const startBtn = document.getElementById('start-btn');
        const statusIndicator = document.getElementById('status-indicator');
        const statusText = document.getElementById('status-text');
        const sourceLangSelect = document.getElementById('source-lang');
        const targetLangSelect = document.getElementById('target-lang');
        const swapLangBtn = document.getElementById('swap-lang-btn');
        const sourceLangHeader = document.getElementById('source-lang-header');
        const targetLangHeader = document.getElementById('target-lang-header');
        const originalTranscript = document.getElementById('original-transcript');
        const translatedTranscript = document.getElementById('translated-transcript');

        let isTranslating = false;
        let audioContext;
        let processor;
        let currentStream;
        const socket = io();

        function updateLanguageHeaders() {
            const sourceLangText = sourceLangSelect.options[sourceLangSelect.selectedIndex].text;
            const targetLangText = targetLangSelect.options[targetLangSelect.selectedIndex].text;
            sourceLangHeader.textContent = `原文 (${sourceLangText})`;
            targetLangHeader.textContent = `翻譯 (${targetLangText})`;
        }

        function swapLanguages() {
            const sourceValue = sourceLangSelect.value;
            sourceLangSelect.value = targetLangSelect.value;
            targetLangSelect.value = sourceValue;
            updateLanguageHeaders();
        }

        function handleLanguageChange() {
            if (sourceLangSelect.value === targetLangSelect.value) {
                for (let i = 0; i < targetLangSelect.options.length; i++) {
                    if (targetLangSelect.options[i].value !== sourceLangSelect.value) {
                        targetLangSelect.value = targetLangSelect.options[i].value;
                        break;
                    }
                }
            }
            updateLanguageHeaders();
        }

        function updateUIForState(state, message = '') {
            if (state === 'translating') {
                startBtn.innerHTML = '<i class="fas fa-microphone-slash mr-2"></i>停止翻譯';
                startBtn.classList.remove('btn-primary');
                startBtn.classList.add('bg-red-500', 'hover:bg-red-600');
                statusIndicator.className = 'status-indicator status-recording';
                statusText.textContent = message || '即時翻譯中...';
            } else { // idle
                startBtn.innerHTML = '<i class="fas fa-play mr-2"></i>開始翻譯';
                startBtn.classList.remove('bg-red-500', 'hover:bg-red-600');
                startBtn.classList.add('btn-primary');
                statusIndicator.className = 'status-indicator status-idle';
                statusText.textContent = '待機中';
            }
        }

        function playAudio(base64Audio) {
            if (!base64Audio) return;
            const audio = new Audio(`data:audio/wav;base64,${base64Audio}`);
            audio.play().catch(e => console.error("Audio playback failed:", e));
        }

        async function startTranslation() {
            if (isTranslating) return;
            isTranslating = true;

            originalTranscript.innerHTML = '';
            translatedTranscript.innerHTML = '';
            updateUIForState('translating');

            socket.emit('start_translation', {
                source_lang: sourceLangSelect.value,
                target_lang: targetLangSelect.value
            });

            try {
                currentStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const source = audioContext.createMediaStreamSource(currentStream);
                processor = audioContext.createScriptProcessor(1024, 1, 1);

                source.connect(processor);
                processor.connect(audioContext.destination);

                processor.onaudioprocess = (e) => {
                    const inputData = e.inputBuffer.getChannelData(0);
                    const downsampled = downsampleBuffer(inputData, 16000);
                    const pcmData = floatTo16BitPCM(downsampled);
                    socket.emit('audio_stream', pcmData);
                };

            } catch (err) {
                console.error("Error starting audio capture:", err);
                alert('無法取得麥克風權限，請檢查瀏覽器設定。');
                stopTranslation();
            }
        }

        function stopTranslation() {
            if (!isTranslating) return;
            isTranslating = false;

            socket.emit('stop_translation');

            if (processor) {
                processor.disconnect();
                processor = null;
            }
            if (audioContext) {
                audioContext.close();
                audioContext = null;
            }
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
            }
            updateUIForState('idle');
        }

        function floatTo16BitPCM(input) {
            const output = new Int16Array(input.length);
            for (let i = 0; i < input.length; i++) {
                const s = Math.max(-1, Math.min(1, input[i]));
                output[i] = s < 0 ? s * 0x8000 : s * 0x7FFF;
            }
            return output.buffer;
        }

        function downsampleBuffer(buffer, targetSampleRate) {
            if (targetSampleRate === audioContext.sampleRate) {
                return buffer;
            }
            const sampleRateRatio = audioContext.sampleRate / targetSampleRate;
            const newLength = Math.round(buffer.length / sampleRateRatio);
            const result = new Float32Array(newLength);
            let offsetResult = 0;
            let offsetBuffer = 0;
            while (offsetResult < result.length) {
                const nextOffsetBuffer = Math.round((offsetResult + 1) * sampleRateRatio);
                let accum = 0, count = 0;
                for (let i = offsetBuffer; i < nextOffsetBuffer && i < buffer.length; i++) {
                    accum += buffer[i];
                    count++;
                }
                result[offsetResult] = accum / count;
                offsetResult++;
                offsetBuffer = nextOffsetBuffer;
            }
            return result;
        }

        // --- Socket.IO Event Listeners ---
        socket.on('connect', () => console.log('Socket.IO connected'));
        socket.on('disconnect', () => console.log('Socket.IO disconnected'));
        
        socket.on('recognized_sentence', (data) => {
            const originalDiv = document.createElement('div');
            originalDiv.id = `original-${data.id}`;
            originalDiv.className = 'transcript-text original-text';
            originalDiv.textContent = data.text;
            originalTranscript.appendChild(originalDiv);
            originalTranscript.scrollTop = originalTranscript.scrollHeight;

            const translatedDiv = document.createElement('div');
            translatedDiv.id = `translated-${data.id}`;
            translatedDiv.className = 'transcript-text translated-text';
            translatedDiv.textContent = '...';
            translatedTranscript.appendChild(translatedDiv);
            translatedTranscript.scrollTop = translatedTranscript.scrollHeight;
        });

        socket.on('translated_sentence', (data) => {
            const translatedDiv = document.getElementById(`translated-${data.id}`);
            if (translatedDiv) {
                translatedDiv.textContent = data.text;
            }
        });

        socket.on('translation_audio', (data) => {
            playAudio(data.audio);
        });

        socket.on('translation_error', (data) => {
            console.error('Translation Error:', data.error);
            alert(`發生錯誤: ${data.error}`);
        });

        // --- DOM Event Listeners ---
        startBtn.addEventListener('click', () => {
            if (!isTranslating) {
                startTranslation();
            } else {
                stopTranslation();
            }
        });

        swapLangBtn.addEventListener('click', swapLanguages);
        sourceLangSelect.addEventListener('change', handleLanguageChange);
        targetLangSelect.addEventListener('change', handleLanguageChange);

        // --- Initial Setup ---
        updateLanguageHeaders();
    });
  </script>
</body>
</html>